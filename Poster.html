<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Post Builder</title>
    <link rel="stylesheet" href="style.css">
        opacity: 0.5;
        pointer-events: none;
        cursor: default;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background: rgba(0,0,0,0.4);
    }
    .modal-content {
        background: #fff;
        margin: 8% auto;
        padding: 2em 2.5em 2em 2.5em;
        border: 2px solid #F6E05E;
        border-radius: 1.2rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 8px 32px 0 rgba(74,85,104,0.18);
        position: relative;
        color: #4A5568;
        font-family: inherit;
    }
    .modal-content label {
        display: block;
        margin-top: 1em;
        font-weight: bold;
        color: #FF6B00;
    }
    .modal-content input[type="text"],
    .modal-content input[type="password"] {
        width: 100%;
        padding: 0.7em;
        margin-top: 0.3em;
        border-radius: 0.7em;
        border: 1px solid #4A5568;
        background: #F7FAFC;
        font-size: 1.1em;
        margin-bottom: 0.7em;
    }
    .modal-content .close {
        position: absolute;
        top: 0.7em;
        right: 1.2em;
        color: #FF6B00;
        font-size: 2em;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
    }
    .modal-content .close:hover {
        color: #E55D00;
    }
    </style>
</head>
<body>
    <div style="background:#ffdddd;color:#a00;padding:1em 2em;font-weight:bold;text-align:center;border-bottom:2px solid #a00;">
        Developer Access Only: This page is private and restricted to authorized developers. Unauthorized access is prohibited.
    </div>
    <div id="header-include"></div>
    <div id="sidebar-include"></div>
    <main>
        <section class="section">
            <h2>Create a New Post</h2>
            <form action="/post-website" method="POST" class="post-form" id="postForm">
                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category" name="category" required>
                        <option value="ComputerScience">Computer Science</option>
                        <option value="Math">Math</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="title">Post Name:</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="body">Body:</label>
                    <div style="display:flex; gap:0.5em; margin-bottom:0.5em;">
                        <button type="button" id="bold-btn" title="Bold"><b>B</b></button>
                        <button type="button" id="underline-btn" title="Underline"><u>U</u></button>
                        <button type="button" id="italic-btn" title="Italics"><i>I</i></button>
                        <button type="button" id="subheading-btn" title="Subheading">H2</button>
                        <button type="button" id="section-btn" title="Section">/s</button>
                    </div>
                    <textarea id="body" name="body" rows="8" required></textarea>
                    <label id="preview-label" style="display:block; margin-top:1em; font-weight:bold; color:#4A5568;">Preview:</label>
                    <div id="body-preview" style="margin-top:0.3em; background:#f7fafc; border-radius:0.7rem; padding:1em; min-height:2em;"></div>
                </div>
                <div class="form-group">
                    <button type="submit">Create Post</button>
                </div>
            </form>
            <script>
            document.getElementById('postForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const params = new URLSearchParams();
                for (const pair of formData) {
                    params.append(pair[0], pair[1]);
                }
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                if (res.ok) {
                    form.reset();
                    alert('Post created successfully!');
                } else {
                    alert('Error creating post.');
                }
            });

            // Live preview for /s, /h, /l, /b, /i, /u as described
            const bodyInput = document.getElementById('body');
            const preview = document.getElementById('body-preview');
            bodyInput.addEventListener('input', function() {
                let html = bodyInput.value;

                // /l /e item /e item/ → <ul><li>item</li><li>item</li></ul>
                html = html.replace(/\/l\s*((?:\/e\s*[^\/]+)+)\/\s*/g, (match, listContent) => {
                    const items = [...listContent.matchAll(/\/e\s*([^\/\n]+)/g)].map(m => `<li>${m[1].trim()}</li>`);
                    return `<ul>${items.join('')}</ul>`;
                });

                // /h text / → <h2>text</h2>
                html = html.replace(/\/h\s*([^\n\/]+)\s*\//g, (match, headerText) => {
                    return `|||H2|||${headerText.trim()}|||H2|||`;
                });

                // /b text / → <b>text</b>
                html = html.replace(/\/b\s*([^\n\/]+)\s*\//g, (match, boldText) => {
                    return `<b>${boldText.trim()}</b>`;
                });

                // /i text / → <i>text</i>
                html = html.replace(/\/i\s*([^\n\/]+)\s*\//g, (match, italicText) => {
                    return `<i>${italicText.trim()}</i>`;
                });

                // /u text / → <u>text</u>
                html = html.replace(/\/u\s*([^\n\/]+)\s*\//g, (match, underlineText) => {
                    return `<u>${underlineText.trim()}</u>`;
                });

                // /s → split into sections for preview
                const sectionParts = html.split(/(?:\r?\n)?\s*\/s\s*(?:\r?\n)?/g);
                html = sectionParts.map(part => {
                    // Split by our fake H2 marker
                    let parts = part.split('|||H2|||');
                    let result = '';
                    for (let i = 0; i < parts.length; i++) {
                        if (i % 2 === 1) {
                            // Heading
                            result += `<h2>${parts[i]}</h2>`;
                        } else {
                            // Paragraphs: split by double newlines or single newlines, wrap in <p>
                            let paras = parts[i].split(/\n{2,}/g).map(p => p.trim()).filter(p => p.length > 0);
                            result += paras.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
                        }
                    }
                    return `<div class="section-preview">${result}</div>`;
                }).join('');

                preview.innerHTML = html;
            });

            // Insert markup at selection or cursor
            function wrapSelection(textarea, before, after) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;
                const selected = value.substring(start, end);
                const newValue = value.substring(0, start) + before + selected + after + value.substring(end);
                textarea.value = newValue;
                // Set cursor after the inserted markup
                if (selected.length === 0) {
                    textarea.selectionStart = textarea.selectionEnd = start + before.length;
                } else {
                    textarea.selectionStart = start + before.length;
                    textarea.selectionEnd = end + before.length;
                }
                textarea.dispatchEvent(new Event('input'));
                textarea.focus();
            }

            function insertAtCursor(textarea, text) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;
                textarea.value = value.substring(0, start) + text + value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + text.length;
                textarea.dispatchEvent(new Event('input'));
                textarea.focus();
            }

            document.getElementById('bold-btn').onclick = function() {
                wrapSelection(document.getElementById('body'), '/b ', ' /');
            };
            document.getElementById('underline-btn').onclick = function() {
                wrapSelection(document.getElementById('body'), '/u ', ' /');
            };
            document.getElementById('italic-btn').onclick = function() {
                wrapSelection(document.getElementById('body'), '/i ', ' /');
            };
            document.getElementById('subheading-btn').onclick = function() {
                wrapSelection(document.getElementById('body'), '/h ', ' /');
            };
            document.getElementById('section-btn').onclick = function() {
                insertAtCursor(document.getElementById('body'), '/s');
            };
            </script>
            <style>
            .section-preview {
                background: #e6e8ea;
                border: 2px solid #4A5568;
                border-radius: 1.2rem;
                margin: 1.2em 0;
                padding: 1.5em 1.2em;
                box-shadow: 0 8px 32px 0 rgba(74,85,104,0.08);
            }
            .form-group > div > button {
                background: #F6E05E;
                color: #4A5568;
                border: 1px solid #4A5568;
                border-radius: 0.5em;
                padding: 0.2em 0.7em;
                font-size: 1.1em;
                font-family: inherit;
                cursor: pointer;
                transition: background 0.2s, color 0.2s;
            }
            .form-group > div > button:hover,
            .form-group > div > button:focus {
                background: #FF6B00;
                color: #fff;
                outline: none;
            }
            </style>
        </section>
        <section class="section" id="all-posts-section">
            <h2>All Posts</h2>
            <div style="margin-bottom:1em;">
                <label for="post-filter" style="font-weight:bold;color:#FF6B00;">Filter:</label>
                <select id="post-filter" style="
                    background: #F7FAFC;
                    color: #4A5568;
                    border: 2px solid #FF6B00;
                    border-radius: 0.7em;
                    padding: 0.6em 1.2em;
                    font-size: 1.1em;
                    margin-left: 0.7em;
                    font-family: inherit;
                    font-weight: bold;
                    outline: none;
                    transition: border 0.2s, box-shadow 0.2s;
                ">
                    <option value="all">All</option>
                    <option value="ComputerScience">Computer Science</option>
                    <option value="Math">Math</option>
                </select>
            </div>
            <div id="posts-list">
                <!-- Posts will be loaded here -->
            </div>
        </section>
    </main>
    <div id="footer-include"></div>
    <script>
    function includeHTML(id, url, cb) {
        fetch(url)
          .then(res => res.text())
          .then(html => {
              document.getElementById(id).innerHTML = html;
              if (cb) cb();
          });
    }
    includeHTML('header-include', 'partials/header.html');
    includeHTML('sidebar-include', 'partials/sidebar.html');
    includeHTML('footer-include', 'partials/footer.html');

    // Fetch and display posts grouped by month and filter
    async function loadPosts() {
        const res = await fetch('list-posts');
        if (!res.ok) {
            document.getElementById('posts-list').innerHTML = '<p style="color:#a00;">Could not load posts.</p>';
            return;
        }
        const posts = await res.json();
        renderPosts(posts, document.getElementById('post-filter').value);
        document.getElementById('post-filter').onchange = function() {
            renderPosts(posts, this.value);
        };
    }

    function renderPosts(posts, filter) {
        let filtered = {};
        if (filter === 'all') {
            filtered = posts;
        } else if (filter === 'ComputerScience') {
            filtered = { ComputerScience: posts.ComputerScience };
        } else if (filter === 'Math') {
            filtered = { Math: posts.Math };
        }
        let months = {};
        for (const [cat, arr] of Object.entries(filtered)) {
            arr.forEach(post => {
                const [day, month, year] = post.date.split('-');
                const monthKey = `${year}-${month}`;
                if (!months[monthKey]) months[monthKey] = [];
                months[monthKey].push({ ...post, category: cat });
            });
        }
        const sortedMonths = Object.keys(months).sort((a, b) => b.localeCompare(a));
        let html = '';
        if (sortedMonths.length === 0) {
            html = '<p>No posts found.</p>';
        }
        for (const monthKey of sortedMonths) {
            const [year, month] = monthKey.split('-');
            const monthName = new Date(`${year}-${month}-01`).toLocaleString('default', { month: 'long', year: 'numeric' });
            html += `<h3 style="color:#4A5568;margin-top:1.5em;">${monthName}</h3><ul style="margin-bottom:1.5em;">`;
            months[monthKey].sort((a, b) => b.date.localeCompare(a.date));
            for (const post of months[monthKey]) {
                html += `<li>
                    <a href="/Posts/${post.category}/${post.filename}" target="_blank" style="font-weight:bold;color:#FF6B00;text-decoration:underline;">${post.title}</a>
                    <span style="color:#4A5568;margin-left:1em;">${post.date}</span>
                    <span style="color:#888;margin-left:0.7em;font-size:0.95em;">[${post.category}]</span>
                    <button class="delete-post-btn" data-category="${post.category}" data-filename="${post.filename}" style="
                        margin-left:1.5em;
                        background:#fff;
                        color:#a00;
                        border:1.5px solid #a00;
                        border-radius:0.5em;
                        padding:0.2em 0.8em;
                        font-size:1em;
                        font-weight:bold;
                        cursor:pointer;
                        transition:background 0.2s,color 0.2s;
                    ">Delete</button>
                </li>`;
            }
            html += '</ul>';
        }
        document.getElementById('posts-list').innerHTML = html;

        // Add delete button logic
        document.querySelectorAll('.delete-post-btn').forEach(btn => {
            btn.onclick = async function() {
                const category = btn.getAttribute('data-category');
                const filename = btn.getAttribute('data-filename');
                const confirmed = confirm(`Are you sure you want to delete "${filename}" from ${category}? This cannot be undone.`);
                if (!confirmed) return;
                const res = await fetch('delete-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category, filename })
                });
                if (res.ok) {
                    // Remove the post from the UI
                    btn.closest('li').remove();
                } else {
                    alert('Failed to delete post.');
                }
            };
        });
    }

    if (window.location.pathname.endsWith('Poster.html')) {
        loadPosts();
    }
    </script>
</body>
</html>
